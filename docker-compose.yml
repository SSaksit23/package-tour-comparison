services:
  # Backend Service - PDF Extraction + AI Agents
  # - PyMuPDF for reliable PDF text extraction
  # - CrewAI for multi-agent analysis
  # - Mem0 for persistent memory
  # - EXA for web search
  pdf-extractor:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: itin-backend
    ports:
      - "5001:5001"
    environment:
      # AI Provider (for CrewAI agents)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Web Search (EXA)
      - EXA_API_KEY=${EXA_API_KEY}
      # Agent Observability (optional)
      - AGENTOPS_API_KEY=${AGENTOPS_API_KEY}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ArangoDB - Multi-model Database (Graph + Vector + Document)
  # Provides unified hybrid RAG with graph traversal and vector search
  arangodb:
    image: arangodb:3.11
    container_name: itin-arangodb
    ports:
      - "8529:8529"
    environment:
      - ARANGO_ROOT_PASSWORD=password123
    volumes:
      - arango_data:/var/lib/arangodb3
    healthcheck:
      test: ["CMD", "arangosh", "--server.password", "password123", "--javascript.execute-string", "db._version()"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ChromaDB - Vector Database (kept as backup/alternative)
  chromadb:
    image: chromadb/chroma:latest
    container_name: itin-chromadb
    ports:
      - "8000:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=TRUE
      - IS_PERSISTENT=TRUE
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["http://localhost:3000","http://localhost:8080","*"]

  # Development mode with hot reload
  dev:
    build:
      context: .
      target: development
    container_name: itin-analyzer-dev
    ports:
      - "3001:3000"
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Keep node_modules from container
      - /app/node_modules
    environment:
      # PDF Extractor service (PyMuPDF backend)
      - PDF_EXTRACTOR_URL=http://localhost:5001
      - PDF_EXTRACTOR_INTERNAL_URL=http://pdf-extractor:5001
      # ArangoDB connection (primary - for hybrid RAG)
      - ARANGO_URL=http://localhost:8529
      - ARANGO_INTERNAL_URL=http://arangodb:8529
      - ARANGO_USER=root
      - ARANGO_PASSWORD=password123
      - ARANGO_DATABASE=itinerary_kb
      # ChromaDB connection (backup)
      - CHROMA_URL=http://localhost:8000
      - CHROMA_INTERNAL_URL=http://chromadb:8000
    depends_on:
      pdf-extractor:
        condition: service_healthy
      arangodb:
        condition: service_healthy
      chromadb:
        condition: service_started
    # Vite will read OPENAI_API_KEY from the mounted .env file
    command: npm run dev

  # Production mode with nginx
  prod:
    build:
      context: .
      target: production
    container_name: itin-analyzer-prod
    ports:
      - "8080:80"
    environment:
      - ARANGO_URL=http://arangodb:8529
      - ARANGO_USER=root
      - ARANGO_PASSWORD=password123
      - ARANGO_DATABASE=itinerary_kb
    depends_on:
      arangodb:
        condition: service_healthy

volumes:
  arango_data:
  chroma_data:
